name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

      - name: Test
        run: npm test -- --run

  bundle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      - name: Build esbuild bundle
        run: npm run build:bundle

      - name: Verify bundle exists
        run: test -f dist/index.js && echo "Bundle OK ($(wc -c < dist/index.js) bytes)"

  validate-mcpb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      - name: Validate MCPB manifest
        run: npx --yes @anthropic-ai/mcpb validate mcpb/

      - name: Build MCPB bundle
        run: npm run build:mcpb

      - name: Verify MCPB bundle
        run: |
          shopt -s nullglob
          MCPB_FILES=(himalaya-mcp-v*.mcpb)
          if [ ${#MCPB_FILES[@]} -eq 0 ]; then
            echo "ERROR: No .mcpb file produced"
            exit 1
          fi
          MCPB_FILE="${MCPB_FILES[0]}"
          echo "MCPB OK: $MCPB_FILE ($(wc -c < "$MCPB_FILE" | tr -d ' ') bytes)"

  validate-plugin:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate plugin.json
        run: python3 -m json.tool himalaya-mcp-plugin/.claude-plugin/plugin.json > /dev/null

      - name: Validate marketplace.json
        run: python3 -m json.tool .claude-plugin/marketplace.json > /dev/null

      - name: Check version consistency
        run: |
          PKG_VER=$(node -p "require('./package.json').version")
          PLUGIN_VER=$(python3 -c "import json; print(json.load(open('himalaya-mcp-plugin/.claude-plugin/plugin.json'))['version'])")
          MARKET_VER=$(python3 -c "import json; print(json.load(open('.claude-plugin/marketplace.json'))['metadata']['version'])")
          echo "package.json: $PKG_VER"
          echo "plugin.json:  $PLUGIN_VER"
          echo "marketplace:  $MARKET_VER"
          [ "$PKG_VER" = "$PLUGIN_VER" ] && [ "$PKG_VER" = "$MARKET_VER" ] && echo "Versions in sync" || { echo "Version mismatch!"; exit 1; }
